{% extends "base.html" %}

{% block title %}All Calls - Remember All Calls{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="hero-title">Remember All Calls</h1>
                <p class="hero-subtitle">AI-powered call transcription and analysis platform</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{{ url_for('upload_call') }}" class="btn btn-light btn-lg">
                    <i class="fas fa-microphone me-2"></i>Record New Call
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="fas fa-brain me-2"></i>Your Calls & Insights</h3>
    </div>

    {% if calls %}
    <div class="row">
    {% for call in calls %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100 animate-fade-in">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                    <i class="fas fa-microphone me-1"></i>{{ call.filename }}
                </h6>
                <span class="badge status-badge
                    {% if call.status == 'completed' %}bg-success
                    {% elif call.status == 'failed' %}bg-danger
                    {% elif call.status in ['transcribing', 'processing'] %}bg-warning
                    {% else %}bg-secondary{% endif %}">
                    {% if call.status == 'uploaded' %}
                        <i class="fas fa-clock me-1"></i>Uploaded
                    {% elif call.status == 'transcribing' %}
                        <i class="fas fa-spinner fa-spin me-1"></i>Transcribing
                    {% elif call.status == 'processing' %}
                        <i class="fas fa-cog fa-spin me-1"></i>Processing
                    {% elif call.status == 'completed' %}
                        <i class="fas fa-check me-1"></i>Complete
                    {% elif call.status == 'failed' %}
                        <i class="fas fa-times me-1"></i>Failed
                    {% endif %}
                    {{ call.status|title }}
                </span>
            </div>
            <div class="card-body">
                <p class="text-muted mb-2">
                    <small><i class="fas fa-calendar me-1"></i>{{ call.upload_timestamp if call.upload_timestamp else 'N/A' }}</small>
                </p>
                
                {% if call.duration_seconds %}
                <p class="text-muted mb-2">
                    <small><i class="fas fa-stopwatch me-1"></i>{{ "%.1f"|format(call.duration_seconds) }}s</small>
                </p>
                {% endif %}
                
                <div class="d-grid">
                    <a href="{{ url_for('call_detail', call_id=call.id) }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye me-1"></i>View Details
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5 animate-fade-in">
        <i class="fas fa-microphone fa-5x mb-4" style="color: var(--primary-blue); opacity: 0.3;"></i>
        <h4 style="color: var(--primary-text);">Ready to remember every detail?</h4>
        <p class="text-muted">Start by recording or uploading your first call to unlock AI-powered insights.</p>
        <a href="{{ url_for('upload_call') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-microphone me-2"></i>Record Your First Call
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-refresh status for processing calls
function refreshStatus() {
    const statusBadges = document.querySelectorAll('.status-badge');
    statusBadges.forEach(badge => {
        if (badge.textContent.includes('Transcribing') || badge.textContent.includes('Processing')) {
            // Find the call ID from the URL
            const card = badge.closest('.card');
            const detailLink = card.querySelector('a[href*="/call/"]');
            if (detailLink) {
                const callId = detailLink.href.match(/\/call\/(\d+)/)[1];
                fetch(`/api/call-status/${callId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'completed') {
                            location.reload();
                        }
                    })
                    .catch(error => console.log('Status check failed:', error));
            }
        }
    });
}

// Check for processing calls every 10 seconds
setInterval(refreshStatus, 10000);
</script>
{% endblock %}